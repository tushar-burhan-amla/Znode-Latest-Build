CREATE PROCEDURE [dbo].[Znode_InsertPartialShippedItems] 
(
	@LineItemId INT,
	@LineItemStateId INT,
	@Quantity numeric(28,6) = 0,
	@TrackingNumber nvarchar(max) ='',
	@status     BIT OUT
)
AS
/* Summary :- This Procedure is used to insert the Partially shipped items 
     Unit Testing 
   EXEC [Znode_InsertPartialShippedItems] @LineItemId = 1467, @LineItemStateId = 10,@Quantity=1
	*/
BEGIN
	SET NOCOUNT ON;

	BEGIN TRY
	BEGIN TRAN
		DECLARE @GetDate DATETIME = dbo.Fn_GetDate();

		DECLARE @ParentOmsOrderLineItemsId INT, @ParentOmsOrderLineItemsIdNew INT, @ChildOmsOrderLineItemsIdNew INT, @OrgiginalQuantity numeric(28,6)

		DECLARE @ZnodeOmsOrderLineItemsParent TABLE ( OmsOrderLineItemsId int)

		DECLARE @ZnodeOmsOrderLineItemsChild TABLE ( OmsOrderLineItemsId int)

		SELECT @ParentOmsOrderLineItemsId = ParentOmsOrderLineItemsId FROM ZnodeOmsOrderLineItems WHERE OmsOrderLineItemsId = @LineItemId 

		SELECT @OrgiginalQuantity = Quantity FROM ZnodeOmsOrderLineItems WHERE OmsOrderLineItemsId = @LineItemId 
		
		--------Insert ParentOmsOrderLineItemsId Data
		INSERT INTO ZnodeOmsOrderLineItems
		(
			ParentOmsOrderLineItemsId,OrderLineItemRelationshipTypeId,OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,[Description]
			, Quantity,Price,[Weight],DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber,PaymentStatusId,TrackingNumber
			,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles,RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo
			,CouponsApplied,ExternalId,IsActive,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,AutoAddonSKU,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5
		)
		OUTPUT INSERTED.OmsOrderLineItemsId INTO @ZnodeOmsOrderLineItemsParent
		SELECT 
			ParentOmsOrderLineItemsId,OrderLineItemRelationshipTypeId,OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,[Description]
			,Quantity,Price,[Weight],DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber,PaymentStatusId,@TrackingNumber
			,IsAutoGeneratedTracking,@LineItemStateId AS OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles,RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo
			,CouponsApplied,ExternalId,IsActive,CreatedBy,@GetDate,ModifiedBy,@GetDate,AutoAddonSKU,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5
		 FROM ZnodeOmsOrderLineItems 
		 WHERE OmsOrderLineItemsId = @ParentOmsOrderLineItemsId 

		 SELECT @ParentOmsOrderLineItemsIdNew = OmsOrderLineItemsId FROM @ZnodeOmsOrderLineItemsParent

		 --------Insert Child Data
		 INSERT INTO ZnodeOmsOrderLineItems
		(
			ParentOmsOrderLineItemsId,OrderLineItemRelationshipTypeId,OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,[Description]
			,Quantity,Price,[Weight],DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber,PaymentStatusId,TrackingNumber
			,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles,RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo
			,CouponsApplied,ExternalId,IsActive,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,AutoAddonSKU,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5
		)
		OUTPUT INSERTED.OmsOrderLineItemsId INTO @ZnodeOmsOrderLineItemsChild
		SELECT 
			@ParentOmsOrderLineItemsIdNew,OrderLineItemRelationshipTypeId,OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,[Description],@Quantity as Quantity,
			Price,[Weight],DownloadLink,((ISNULL(DiscountAmount,0) / NULLIF(@OrgiginalQuantity,0)) * @Quantity) as DiscountAmount,ShipSeparately,ShipDate,ReturnDate,
			((ISNULL(ShippingCost,0) / NULLIF(@OrgiginalQuantity,0)) * @Quantity) as ShippingCost,PromoDescription,TransactionNumber,PaymentStatusId,@TrackingNumber ,IsAutoGeneratedTracking,
			@LineItemStateId AS OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles,RecurringBillingFrequency,RecurringBillingAmount,
			AppliedPromo,CouponsApplied,ExternalId,IsActive,CreatedBy,@GetDate,ModifiedBy,@GetDate,AutoAddonSKU,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5
		 FROM ZnodeOmsOrderLineItems 
		 WHERE OmsOrderLineItemsId = @LineItemId 

		 SELECT @ChildOmsOrderLineItemsIdNew = OmsOrderLineItemsId FROM @ZnodeOmsOrderLineItemsChild

		 ----------ZnodeOmsArtifiDesign
		INSERT INTO ZnodeOmsArtifiDesign ( OmsOrderLineItemsId,OmsSavedCartLineItemId,ArtifiDesignId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT @ParentOmsOrderLineItemsIdNew,OmsSavedCartLineItemId,ArtifiDesignId,CreatedBy,@GetDate,ModifiedBy,@GetDate
		FROM ZnodeOmsArtifiDesign WHERE OmsOrderLineItemsId = @ParentOmsOrderLineItemsId

		INSERT INTO ZnodeOmsArtifiDesign ( OmsOrderLineItemsId,OmsSavedCartLineItemId,ArtifiDesignId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT @ChildOmsOrderLineItemsIdNew,OmsSavedCartLineItemId,ArtifiDesignId,CreatedBy,@GetDate,ModifiedBy,@GetDate
		FROM ZnodeOmsArtifiDesign WHERE OmsOrderLineItemsId = @LineItemId

		---------ZnodeOmsOrderAttribute
		INSERT INTO ZnodeOmsOrderAttribute ( OmsOrderLineItemsId,AttributeCode,AttributeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,AttributeValueCode)
		SELECT @ParentOmsOrderLineItemsIdNew,AttributeCode,AttributeValue,CreatedBy,@GetDate,ModifiedBy,@GetDate,AttributeValueCode
		FROM ZnodeOmsOrderAttribute WHERE OmsOrderLineItemsId = @ParentOmsOrderLineItemsId

		INSERT INTO ZnodeOmsOrderAttribute ( OmsOrderLineItemsId,AttributeCode,AttributeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,AttributeValueCode)
		SELECT OmsOrderLineItemsId,AttributeCode,AttributeValue,CreatedBy,@GetDate,ModifiedBy,@GetDate,AttributeValueCode
		FROM ZnodeOmsOrderAttribute WHERE OmsOrderLineItemsId = @LineItemId

		-----------ZnodeOmsOrderLineItemsShipping
		INSERT INTO ZnodeOmsOrderLineItemsShipping ( OmsOrderId,OmsOrderLineItemsId,OrderLineItemStateId,Quantity,ShippingId,ShippingCost,TrackingNumber,TaxCost,Price,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT OmsOrderId,@ParentOmsOrderLineItemsIdNew,OrderLineItemStateId,Quantity,ShippingId,ShippingCost,TrackingNumber,TaxCost,Price,CreatedBy,@GetDate,ModifiedBy,@GetDate
		FROM ZnodeOmsOrderLineItemsShipping WHERE OmsOrderLineItemsId = @ParentOmsOrderLineItemsId

		INSERT INTO ZnodeOmsOrderLineItemsShipping ( OmsOrderId,OmsOrderLineItemsId,OrderLineItemStateId,Quantity,ShippingId,ShippingCost,TrackingNumber,TaxCost,Price,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT OmsOrderId,@ChildOmsOrderLineItemsIdNew,OrderLineItemStateId,Quantity,ShippingId,ShippingCost,TrackingNumber,TaxCost,Price,CreatedBy,@GetDate,ModifiedBy,@GetDate
		FROM ZnodeOmsOrderLineItemsShipping WHERE OmsOrderLineItemsId = @LineItemId

		-----------ZnodeOmsOrderWarehouse
		INSERT INTO ZnodeOmsOrderWarehouse ( OmsOrderDetailsId,OmsOrderLineItemsId,WarehouseId,Quantity,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate )
		SELECT OmsOrderDetailsId,@ParentOmsOrderLineItemsIdNew,WarehouseId,Quantity,CreatedBy,@GetDate,ModifiedBy,@GetDate
		FROM ZnodeOmsOrderWarehouse WHERE OmsOrderLineItemsId = @ParentOmsOrderLineItemsId

		INSERT INTO ZnodeOmsOrderWarehouse ( OmsOrderDetailsId,OmsOrderLineItemsId,WarehouseId,Quantity,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate )
		SELECT OmsOrderDetailsId,@ChildOmsOrderLineItemsIdNew,WarehouseId,Quantity,CreatedBy,@GetDate,ModifiedBy,@GetDate
		FROM ZnodeOmsOrderWarehouse WHERE OmsOrderLineItemsId = @LineItemId

		-----------ZnodeOmsOrderDiscount
		INSERT INTO ZnodeOmsOrderDiscount ( OmsOrderLineItemId,OmsDiscountTypeId,DiscountCode,DiscountAmount,Description,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate )
		SELECT @ParentOmsOrderLineItemsIdNew,OmsDiscountTypeId,DiscountCode,DiscountAmount,Description,CreatedBy,@GetDate,ModifiedBy,@GetDate
		FROM ZnodeOmsOrderDiscount WHERE OmsOrderLineItemId = @ParentOmsOrderLineItemsId

		INSERT INTO ZnodeOmsOrderDiscount ( OmsOrderLineItemId,OmsDiscountTypeId,DiscountCode,DiscountAmount,Description,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate )
		SELECT @ChildOmsOrderLineItemsIdNew,OmsDiscountTypeId,DiscountCode,DiscountAmount,Description,CreatedBy,@GetDate,ModifiedBy,@GetDate
		FROM ZnodeOmsOrderDiscount WHERE OmsOrderLineItemId = @LineItemId

		-----------ZnodeOmsPaymentRefund
		INSERT INTO ZnodeOmsPaymentRefund ( OmsOrderDetailsId,OmsOrderLineItemsId,RefundAmount,RefundTaxAmount,Notes,OmsRefundTypeId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate )
		SELECT OmsOrderDetailsId,@ParentOmsOrderLineItemsIdNew,RefundAmount,RefundTaxAmount,Notes,OmsRefundTypeId,CreatedBy,@GetDate,ModifiedBy,@GetDate
		FROM ZnodeOmsPaymentRefund WHERE OmsOrderLineItemsId = @ParentOmsOrderLineItemsId 

		INSERT INTO ZnodeOmsPaymentRefund ( OmsOrderDetailsId,OmsOrderLineItemsId,RefundAmount,RefundTaxAmount,Notes,OmsRefundTypeId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate )
		SELECT OmsOrderDetailsId,@ChildOmsOrderLineItemsIdNew,RefundAmount,RefundTaxAmount,Notes,OmsRefundTypeId,CreatedBy,@GetDate,ModifiedBy,@GetDate
		FROM ZnodeOmsPaymentRefund WHERE OmsOrderLineItemsId = @LineItemId

		-----------ZnodeOmsPersonalizeItem
		INSERT INTO ZnodeOmsPersonalizeItem ( OmsOrderLineItemsId,PersonalizeCode,PersonalizeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate )
		SELECT @ParentOmsOrderLineItemsIdNew,PersonalizeCode,PersonalizeValue,CreatedBy,@GetDate,ModifiedBy,@GetDate
		FROM ZnodeOmsPersonalizeItem WHERE OmsOrderLineItemsId = @ParentOmsOrderLineItemsId 

		INSERT INTO ZnodeOmsPersonalizeItem ( OmsOrderLineItemsId,PersonalizeCode,PersonalizeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate )
		SELECT @ChildOmsOrderLineItemsIdNew,PersonalizeCode,PersonalizeValue,CreatedBy,@GetDate,ModifiedBy,@GetDate
		FROM ZnodeOmsPersonalizeItem WHERE OmsOrderLineItemsId = @LineItemId 

		-----------ZnodeOmsTaxOrderLineDetails
		INSERT INTO ZnodeOmsTaxOrderLineDetails ( OmsOrderLineItemsId,TaxRuleId,TaxTransactionNumber,Comments,SalesTax,VAT,GST,PST,HST,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate )
		SELECT @ParentOmsOrderLineItemsIdNew,TaxRuleId,TaxTransactionNumber,Comments,SalesTax,VAT,GST,PST,HST,CreatedBy,@GetDate,ModifiedBy,@GetDate
		FROM ZnodeOmsTaxOrderLineDetails WHERE OmsOrderLineItemsId = @ParentOmsOrderLineItemsId 

		INSERT INTO ZnodeOmsTaxOrderLineDetails ( OmsOrderLineItemsId,TaxRuleId,TaxTransactionNumber,Comments,SalesTax,VAT,GST,PST,HST,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate )
		SELECT @ChildOmsOrderLineItemsIdNew,TaxRuleId,TaxTransactionNumber,Comments,((ISNULL(SalesTax,0) / NULLIF(@OrgiginalQuantity,0)) * @Quantity) as SalesTax,((ISNULL(VAT,0) / NULLIF(@OrgiginalQuantity,0)) * @Quantity) as VAT,
		((ISNULL(GST,0) / NULLIF(@OrgiginalQuantity,0)) * @Quantity) as GST,((ISNULL(PST,0) / NULLIF(@OrgiginalQuantity,0)) * @Quantity) as PST,((ISNULL(HST,0) / NULLIF(@OrgiginalQuantity,0)) * @Quantity) as HST,CreatedBy,@GetDate,ModifiedBy,@GetDate
		FROM ZnodeOmsTaxOrderLineDetails WHERE OmsOrderLineItemsId = @LineItemId 

		-----------ZnodeOmsTaxOrderLineDetails
		INSERT INTO ZnodeRmaRequestItem ( RmaRequestId,OmsOrderLineItemsId,IsReceived,IsReturnable,GiftCardId,Quantity,Price,RmaReasonForReturnId,TransactionId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate )
		SELECT RmaRequestId,@ParentOmsOrderLineItemsIdNew,IsReceived,IsReturnable,GiftCardId,Quantity,Price,RmaReasonForReturnId,TransactionId,CreatedBy,@GetDate,ModifiedBy,@GetDate
		FROM ZnodeRmaRequestItem WHERE OmsOrderLineItemsId = @ParentOmsOrderLineItemsId  

		INSERT INTO ZnodeRmaRequestItem ( RmaRequestId,OmsOrderLineItemsId,IsReceived,IsReturnable,GiftCardId,Quantity,Price,RmaReasonForReturnId,TransactionId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate )
		SELECT RmaRequestId,@ChildOmsOrderLineItemsIdNew,IsReceived,IsReturnable,GiftCardId,Quantity,Price,RmaReasonForReturnId,TransactionId,CreatedBy,@GetDate,ModifiedBy,@GetDate
		FROM ZnodeRmaRequestItem WHERE OmsOrderLineItemsId = @LineItemId 

		-----------ZnodeOmsDownloadableProductKey
		INSERT INTO ZnodeOmsDownloadableProductKey ( OmsOrderLineItemsId,PimDownloadableProductKeyId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate )
		SELECT @ParentOmsOrderLineItemsIdNew,PimDownloadableProductKeyId,CreatedBy,@GetDate,ModifiedBy,@GetDate
		FROM ZnodeOmsDownloadableProductKey WHERE OmsOrderLineItemsId = @ParentOmsOrderLineItemsId 

		INSERT INTO ZnodeOmsDownloadableProductKey ( OmsOrderLineItemsId,PimDownloadableProductKeyId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate )
		SELECT @ChildOmsOrderLineItemsIdNew,PimDownloadableProductKeyId,CreatedBy,@GetDate,ModifiedBy,@GetDate
		FROM ZnodeOmsDownloadableProductKey WHERE OmsOrderLineItemsId = @LineItemId


		UPDATE ZnodeOmsOrderLineItems SET Quantity = (Quantity - @Quantity), ModifiedDate = @GetDate WHERE OmsOrderLineItemsId = @LineItemId 

		-- SELECT * FROM @ZnodeOmsOrderLineItems
		SET @status = 1;
	COMMIT TRAN
	END TRY
         BEGIN CATCH
       --      DECLARE @Status BIT ;
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_InsertPartialShippedItems @LineItemStateId = '+CAST(@LineItemStateId AS VARCHAR(10))+',@Quantity='+CAST(@Quantity AS VARCHAR(50))+',@TrackingNumber='+CAST(@TrackingNumber AS VARCHAR(50))
              			 
             --SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
			ROLLBACK TRAN
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_InsertPartialShippedItems',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
    END CATCH;
END