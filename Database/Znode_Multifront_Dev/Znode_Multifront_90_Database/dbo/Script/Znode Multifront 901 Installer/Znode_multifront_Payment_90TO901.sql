/*
Deployment script for Znode_Multifront_Payment_90

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO


/*
The column [dbo].[ZnodeTransactions].[Custom2] is being dropped, data loss could occur.

The column [dbo].[ZnodeTransactions].[Custom3] is being dropped, data loss could occur.
*/

--IF EXISTS (select top 1 1 from [dbo].[ZnodeTransactions])
    --RAISERROR (N'Rows were detected. The schema update is terminating because data loss might occur.', 16, 127) WITH NOWAIT

GO
PRINT N'Dropping [dbo].[FK_Znode_Transactions_ZNodePaymentSetting]...';


GO
ALTER TABLE [dbo].[ZnodeTransactions] DROP CONSTRAINT [FK_Znode_Transactions_ZNodePaymentSetting];


GO
PRINT N'Starting rebuilding table [dbo].[ZnodeTransactions]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_ZnodeTransactions] (
    [GUID]                   UNIQUEIDENTIFIER NOT NULL,
    [CustomerProfileId]      NVARCHAR (MAX)   NULL,
    [CustomerPaymentId]      NVARCHAR (MAX)   NULL,
    [TransactionId]          NVARCHAR (MAX)   NULL,
    [TransactionDate]        DATETIME         NULL,
    [CaptureTransactionDate] DATETIME         NULL,
    [RefundTransactionDate]  DATETIME         NULL,
    [ResponseText]           NVARCHAR (MAX)   NULL,
    [ResponseCode]           NVARCHAR (50)    NULL,
    [Custom1]                NVARCHAR (MAX)   NULL,
    [RefundTransactionId]    NVARCHAR (MAX)   NULL,
    [CaptureTransactionId]   NVARCHAR (MAX)   NULL,
    [Amount]                 MONEY            NULL,
    [PaymentSettingId]       INT              NULL,
    [CurrencyCode]           NVARCHAR (50)    NULL,
    [SubscriptionId]         NVARCHAR (MAX)   NULL,
    [PaymentStatusId]        INT              NULL,
    [RefundAmount]           NUMERIC (12, 6)  NULL,
    [CreatedDate]            DATETIME         NOT NULL,
    [ModifiedDate]           DATETIME         NOT NULL,
    CONSTRAINT [tmp_ms_xx_constraint_PK_Znode_Transactions1] PRIMARY KEY CLUSTERED ([GUID] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[ZnodeTransactions])
    BEGIN
        INSERT INTO [dbo].[tmp_ms_xx_ZnodeTransactions] ([GUID], [CustomerProfileId], [CustomerPaymentId], [TransactionId], [TransactionDate], [CaptureTransactionDate], [RefundTransactionDate], [ResponseText], [ResponseCode], [Custom1], [Amount], [PaymentSettingId], [CurrencyCode], [SubscriptionId], [PaymentStatusId], [RefundAmount], [CreatedDate], [ModifiedDate])
        SELECT   [GUID],
                 [CustomerProfileId],
                 [CustomerPaymentId],
                 [TransactionId],
                 [TransactionDate],
                 [CaptureTransactionDate],
                 [RefundTransactionDate],
                 [ResponseText],
                 [ResponseCode],
                 [Custom1],
                 [Amount],
                 [PaymentSettingId],
                 [CurrencyCode],
                 [SubscriptionId],
                 [PaymentStatusId],
                 [RefundAmount],
                 [CreatedDate],
                 [ModifiedDate]
        FROM     [dbo].[ZnodeTransactions]
        ORDER BY [GUID] ASC;
    END

DROP TABLE [dbo].[ZnodeTransactions];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_ZnodeTransactions]', N'ZnodeTransactions';

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_constraint_PK_Znode_Transactions1]', N'PK_Znode_Transactions', N'OBJECT';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
PRINT N'Creating [dbo].[FK_Znode_Transactions_ZNodePaymentSetting]...';


GO
ALTER TABLE [dbo].[ZnodeTransactions] WITH NOCHECK
    ADD CONSTRAINT [FK_Znode_Transactions_ZNodePaymentSetting] FOREIGN KEY ([PaymentSettingId]) REFERENCES [dbo].[ZNodePaymentSetting] ([PaymentSettingId]);


GO
PRINT N'Checking existing data against newly created constraints';





GO
ALTER TABLE [dbo].[ZnodeTransactions] WITH CHECK CHECK CONSTRAINT [FK_Znode_Transactions_ZNodePaymentSetting];

/*
This script was created by Visual Studio on 6/7/2017 at 9:18 PM.
Run this script on MSD081\SQL2014.Znode_Multifront_Payment_90 (sa) to make it the same as mssvr039.Znode_Multifront_Payment_90_UAT (sa).
This script performs its actions in the following order:
1. Disable foreign-key constraints.
2. Perform DELETE commands. 
3. Perform UPDATE commands.
4. Perform INSERT commands.
5. Re-enable foreign-key constraints.
Please back up your target database before running this script.
*/
SET NUMERIC_ROUNDABORT OFF
GO
SET XACT_ABORT, ANSI_PADDING, ANSI_WARNINGS, CONCAT_NULL_YIELDS_NULL, ARITHABORT, QUOTED_IDENTIFIER, ANSI_NULLS ON
GO
/*Pointer used for text / image updates. This might not be needed, but is declared here just in case*/
DECLARE @pv binary(16)
BEGIN TRANSACTION
ALTER TABLE [dbo].[ZnodeTransactions] DROP CONSTRAINT [FK_Znode_Transactions_ZNodePaymentSetting]
ALTER TABLE [dbo].[ZNodePaymentSettingCredential] DROP CONSTRAINT [FK_ZNodePaymentSettingCredential_ZNodePaymentSetting]
ALTER TABLE [dbo].[ZnodePaymentMethods] DROP CONSTRAINT [FK_ZnodePaymentMethods_CreditCardAddressId]
ALTER TABLE [dbo].[ZnodePaymentMethods] DROP CONSTRAINT [FK_ZnodePaymentMethods_CustomersGUID]
ALTER TABLE [dbo].[ZnodePaymentMethods] DROP CONSTRAINT [FK_ZnodePaymentMethods_PaymentSettingID]
ALTER TABLE [dbo].[ZNodePaymentSetting] DROP CONSTRAINT [FK_SC_PaymentSetting_SC_Gateway]
ALTER TABLE [dbo].[ZNodePaymentSetting] DROP CONSTRAINT [FK_ZNodePaymentSetting_ZNodePaymentType]
DELETE FROM [dbo].[ZNodePaymentGateway] WHERE [PaymentGatewayId]=3
ALTER TABLE [dbo].[ZnodeTransactions]
    ADD CONSTRAINT [FK_Znode_Transactions_ZNodePaymentSetting] FOREIGN KEY ([PaymentSettingId]) REFERENCES [dbo].[ZNodePaymentSetting] ([PaymentSettingId])
ALTER TABLE [dbo].[ZNodePaymentSettingCredential]
    ADD CONSTRAINT [FK_ZNodePaymentSettingCredential_ZNodePaymentSetting] FOREIGN KEY ([PaymentSettingId]) REFERENCES [dbo].[ZNodePaymentSetting] ([PaymentSettingId])
ALTER TABLE [dbo].[ZnodePaymentMethods]
    ADD CONSTRAINT [FK_ZnodePaymentMethods_CreditCardAddressId] FOREIGN KEY ([CreditCardAddressId]) REFERENCES [dbo].[ZnodePaymentAddress] ([CreditCardAddressId])
ALTER TABLE [dbo].[ZnodePaymentMethods]
    ADD CONSTRAINT [FK_ZnodePaymentMethods_CustomersGUID] FOREIGN KEY ([CustomersGUID]) REFERENCES [dbo].[ZnodePaymentCustomers] ([CustomersGUID])
ALTER TABLE [dbo].[ZnodePaymentMethods]
    ADD CONSTRAINT [FK_ZnodePaymentMethods_PaymentSettingID] FOREIGN KEY ([PaymentSettingID]) REFERENCES [dbo].[ZNodePaymentSetting] ([PaymentSettingId])
ALTER TABLE [dbo].[ZNodePaymentSetting]
    ADD CONSTRAINT [FK_SC_PaymentSetting_SC_Gateway] FOREIGN KEY ([PaymentGatewayId]) REFERENCES [dbo].[ZNodePaymentGateway] ([PaymentGatewayId])
ALTER TABLE [dbo].[ZNodePaymentSetting]
    ADD CONSTRAINT [FK_ZNodePaymentSetting_ZNodePaymentType] FOREIGN KEY ([PaymentTypeId]) REFERENCES [dbo].[ZNodePaymentType] ([PaymentTypeId])
COMMIT TRANSACTION

GO
PRINT N'Update complete.';


GO
