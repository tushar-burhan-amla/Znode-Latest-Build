importScripts("libflac3-1.3.2.min.js");var flac_encoder,BUFSIZE=4096,CHANNELS=1,SAMPLERATE=44100,COMPRESSION=5,BPS=16,flac_ok=1,flacLength=0,flacBuffers=[],WAVFILE=!1,INIT=!1,wavLength=0,wavBuffers=[];function write_callback_fn(e,a){flacBuffers.push(e),flacLength+=e.byteLength}function write_wav(e){wavBuffers.push(e),wavLength+=e.length}function initFlac(){if(0!=(flac_encoder=Flac.init_libflac_encoder(SAMPLERATE,CHANNELS,BPS,COMPRESSION,0))){var e=Flac.init_encoder_stream(flac_encoder,write_callback_fn);flac_ok&=0==e,console.log("flac init     : "+flac_ok),console.log("status encoder: "+e),INIT=!0}else console.error("Error initializing the encoder.")}function encodeFlac(e){if(Flac.isReady()){if(0<wavBuffers.length)for(var a=wavBuffers.length,n=wavBuffers.splice(0,a),t=0;t<a;++t)doEncodeFlac(n[t]);doEncodeFlac(e)}else wavBuffers.push(e),console.info("buffered audio data for Flac encdoing")}function doEncodeFlac(e){for(var a=e.length,n=new Uint32Array(a),t=new DataView(n.buffer),c=0,f=0;f<a;f++)t.setInt32(c,32767*e[f],!0),c+=4;var o=Flac.FLAC__stream_encoder_process_interleaved(flac_encoder,n,n.length/CHANNELS);1!=o&&console.log("Error: encode_buffer_pcm_as_flac returned false. "+o)}function exportFlacFile(e,a){var n=mergeBuffersUint8(e,a);return new Blob([n],{type:"audio/flac"})}function exportMonoWAV(e,a){for(var n=2*a,t=new ArrayBuffer(44+n),c=new DataView(t),f=e[0],o=f.length,r=0;r<o;++r)c.setUint8(r,f[r]);return c.setUint32(4,32+n,!0),c.setUint32(40,n,!0),floatTo16BitPCM(c,44,e),new Blob([c],{type:"audio/wav"})}function writeUTFBytes(e,a,n){for(var t=n.length,c=0;c<t;++c)e.setUint8(a+c,n.charCodeAt(c))}function mergeBuffersUint8(e,a){for(var n=new Uint8Array(a),t=0,c=e.length,f=0;f<c;f++){var o=e[f];n.set(o,t),t+=o.length}return n}function floatTo16BitPCM(e,a,n){for(var t,c,f,o,r=n.length,i=1;i<r;++i)for(c=(t=n[i]).length,f=0;f<c;++f,a+=2)o=Math.max(-1,Math.min(1,t[f])),e.setInt16(a,o<0?32768*o:32767*o,!0)}function clear(){flacBuffers.splice(0,flacBuffers.length),flacLength=0,wavBuffers.splice(0,wavBuffers.length),wavLength=0}self.onmessage=function(e){switch(e.data.cmd){case"save_as_wavfile":0==INIT&&(WAVFILE=!0);break;case"init":if(WAVFILE){var a=new ArrayBuffer(44),n=new DataView(a);writeUTFBytes(n,0,"RIFF"),writeUTFBytes(n,8,"WAVE"),writeUTFBytes(n,12,"fmt "),n.setUint32(16,16,!0),n.setUint16(20,1,!0),n.setUint16(22,1,!0),n.setUint32(24,e.data.config.samplerate,!0),n.setUint32(28,2*e.data.config.samplerate,!0),n.setUint16(32,4,!0),n.setUint16(34,16,!0),writeUTFBytes(n,36,"data"),n.setUint32(4,10,!0),n.setUint32(40,10,!0),wavBuffers.push(new Uint8Array(a))}else e.data.config||(e.data.config={bps:BPS,channels:CHANNELS,samplerate:SAMPLERATE,compression:COMPRESSION}),e.data.config.channels=e.data.config.channels?e.data.config.channels:CHANNELS,e.data.config.samplerate=e.data.config.samplerate?e.data.config.samplerate:SAMPLERATE,e.data.config.bps=e.data.config.bps?e.data.config.bps:BPS,e.data.config.compression=e.data.config.compression?e.data.config.compression:COMPRESSION,COMPRESSION=e.data.config.compression,BPS=e.data.config.bps,SAMPLERATE=e.data.config.samplerate,CHANNELS=e.data.config.channels,Flac.isReady()?initFlac():Flac.onready=function(){setTimeout(function(){initFlac()},0)};break;case"encode":WAVFILE?write_wav(e.data.buf):encodeFlac(e.data.buf);break;case"finish":var t;WAVFILE?t=exportMonoWAV(wavBuffers,wavLength):Flac.isReady()?(flac_ok&=Flac.FLAC__stream_encoder_finish(flac_encoder),console.log("flac finish: "+flac_ok),t=exportFlacFile(flacBuffers,flacLength,mergeBuffersUint8),Flac.FLAC__stream_encoder_delete(flac_encoder)):console.error("Flac was not initialized: could not encode data!"),clear(),self.postMessage({cmd:"end",buf:t}),INIT=!1}};